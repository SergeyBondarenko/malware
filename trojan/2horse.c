#include "lib/Common.h"

int main(int argc, char *argv[])
{
	int sock, portN, n;
	unsigned long bytes_recvd, bytes_sent, bytes_total = 0;
	struct sockaddr_in servAddr;
	struct hostent *servName;
	char buffer[BUFFSIZE], *myStr, *myMessage;
	
	if (argc < 3){
	   fprintf(stderr,"usage %s hostname port\n", argv[0]);
	   exit(0);
	}
	portN = atoi(argv[2]);
	
	/* Create a socket point */
	sock = socket(AF_INET, SOCK_STREAM, 0);
	if(sock < 0)
		DieWithError(666, "socket() filed!");
	
	servName = gethostbyname(argv[1]);
	if (servName == NULL) 
		DieWithError(sock, "No such host!");
	
	bzero((char *) &servAddr, sizeof(servAddr));
	servAddr.sin_family = AF_INET;
	bcopy((char *)servName->h_addr, (char *)&servAddr.sin_addr.s_addr, servName->h_length);
	servAddr.sin_port = htons(portN);
	

	/* Now connect to the servName */
	while(1){
		if (connect(sock, (struct sockaddr*)&servAddr, sizeof(servAddr)) < 0){
			printf( "connect() failed!\n");
			sleep(SLEEPTIME);
		} else
			break;
	}
	
	myStr = "Hello! Wellcome my friend!";
	myMessage = malloc(strlen(myStr) * sizeof(char));
	if(myMessage == NULL)
		DieWithError(sock, "malloc() failed!");
	strcpy(myMessage, myStr);
	
	/* Send message to the server */
	//bytes_sent = send(sock, buffer, strlen(buffer), 0);
	bytes_total = strlen(myStr);
	while(1){
		bytes_sent = send(sock, myMessage, strlen(myStr), 0);
		if (bytes_sent < 0)
			DieWithError(sock, "send() failed!");
		
		bytes_total -= bytes_sent;
		if(bytes_total == 0){
			shutdown(sock, SHUT_WR);
			break;
		}
	}

	free(myMessage);
	
	/* Now read servName response */
	bzero(buffer, BUFFSIZE);
	while((bytes_recvd = recv(sock, buffer, BUFFSIZE, 0)) > 0)
		bytes_total += bytes_recvd;	
	
	if (bytes_recvd < 0)
		DieWithError(sock, "recv() failed!");

	printf("%s\n", buffer);
	
	close(sock);
	
	return 0;
}
