#include "lib/Common.h"

int main( int argc, char *argv[] )
{
	int sock, clnt_sock, portN, clntLen;
	unsigned long bytes_recvd, bytes_sent, bytes_total;
	char buffer[BUFFSIZE], *myStr, *myMessage;
	struct sockaddr_in servAddr, clntAddr;
	
	if (argc < 2 || argc > 2){
		printf("Syntax: %s <PORT>\n", argv[0]);
		exit(1);
	}
	portN = atoi(argv[1]);

	while(1){
		/* First call to socket() function */
		sock = socket(AF_INET, SOCK_STREAM, 0);
		if (sock < 0)
			DieWithError(666, "socket() failed!");
		
		/* Initialize socket structure */
		bzero((char *) &servAddr, sizeof(servAddr));
		servAddr.sin_family = AF_INET;
		servAddr.sin_addr.s_addr = INADDR_ANY;
		servAddr.sin_port = htons(portN);
		
		/* Now bind the host address using bind() call.*/
		if (bind(sock, (struct sockaddr *) &servAddr, sizeof(servAddr)) < 0)
			DieWithError(sock, "bind() failed!");
		   
		/* Now start listening for the clients, here process will
		* go in sleep mode and will wait for the incoming connection
		*/
		
		if(listen(sock, MAXPENDING) < 0)
			DieWithError(sock, "listen() failed!");		

		clntLen = sizeof(clntAddr);
		
		/* Accept actual connection from the client */
		clnt_sock = accept(sock, (struct sockaddr *)&clntAddr, &clntLen);
		if (clnt_sock < 0)
		DieWithError(sock, "accept() failed!");
	
		/* If connection is established then start communicating */
		bzero(buffer, BUFFSIZE);
		//bytes_recvd = read( clnt_sock,buffer,255 );
		///bytes_recvd = recv(clnt_sock, buffer, BUFFSIZE, 0);
		bytes_total = 0;
		while((bytes_recvd = recv(clnt_sock, buffer, BUFFSIZE, 0)) > 0)
			bytes_total += bytes_recvd;

		if (bytes_recvd < 0)
			DieWithError(sock, "recv() failed!");
		
		printf("Here is the message: %s\n",buffer);
		
		/* Write a response to the client */
		while(1){
			printf("shell> ");
			bzero(buffer, BUFFSIZE);
			fgets(buffer, BUFFSIZE, stdin);
	
			if(strcmp(myCmd, "horse exit") == 0)
				break;
			else {
				bytes_total = strlen(buffer);
				while(1){
					bytes_sent = send(clnt_sock, myMessage, strlen(myStr), 0);
					if (bytes_sent < 0)
						DieWithError(sock, "send() failed!");
					
					bytes_total -= bytes_sent;
					if(bytes_total == 0){
						shutdown(clnt_sock, SHUT_WR);
						break;
					}
				}
			}
		}

		/*myStr = "I got your message!";
		myMessage = malloc(strlen(myStr) * sizeof(char));
		if(myMessage == NULL)
			DieWithError(sock, "malloc() failed!");
		strcpy(myMessage, myStr);

		bytes_total = strlen(myStr);
		while(1){
			bytes_sent = send(clnt_sock, myMessage, strlen(myStr), 0);
			if (bytes_sent < 0)
				DieWithError(sock, "send() failed!");
			
			bytes_total -= bytes_sent;
			if(bytes_total == 0){
				shutdown(clnt_sock, SHUT_WR);
				break;
			}
		}*/
		   
		free(myMessage);

		close(clnt_sock);
		close(sock);
    }

	return 0;
}
