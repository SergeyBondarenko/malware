#include "TCPServer.h"

void SysCmd(int clntSock, char *buffer)
{
	char local_buffer[BUFFSIZE], *cmd_name, *cmd_args, *file_name, *header[BUFFSIZE];
	long bytes_sent, all_bytes_sent;
	DIR *dir;
	struct dirent *dp;
	
	printf("%s\n", buffer);
	
	memset(local_buffer, 0, sizeof(local_buffer));
	memset(header, 0, BUFFSIZE);
	
	// Parse buffer to get EXEC commands
	parseARGS(header, buffer);
	cmd_name = header[1];
	cmd_args = header[2];
	
	printf("Args: %s\n", cmd_args);
	
	if(strlen(cmd_name) > 0 && strlen(cmd_args) > 0){

		// Execute command "dir"
		if(!strcmp(cmd_name, "dir")){
		
			// Open directory
			dir = opendir(cmd_args);
			if(!dir)
				DieWithError("opendir() failed!\n");
			else {
				// Read the directory and copy all file/dir names to local_buffer array
				while((dp = readdir(dir)) != NULL) {
					if (!strcmp(dp->d_name, ".") || !strcmp(dp->d_name, "..")){
		       		    // do nothing (straight logic)
		       		} else {
		       		   file_name = dp->d_name; // use it
							strcat(local_buffer, file_name);
							strcat(local_buffer, ":");
		       		}	
				}
		
				// Server status msg
				printf("%s\n", local_buffer);
		
				// Send info about files/dirs to client.
				// Repeat while amount of all sent Bytes equals BUFFSIZE. 
				all_bytes_sent = 0;
				while(all_bytes_sent != sizeof(local_buffer)){
					if((bytes_sent = send(clntSock, (local_buffer + all_bytes_sent), (sizeof(local_buffer) - all_bytes_sent), 0)) < 0)	
						DieWithError("send() failed!\n");
		
					all_bytes_sent += bytes_sent;	
				}
			}
		
			// Close directory
			closedir(dir);
		}
	}
}
