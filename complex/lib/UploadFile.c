#include <TCPServer.h>

void UploadFile(int clntSock, char *buffer)
{
	char *file_name, *header[BUFFSIZE];
	long bytes_recvd, bytes_written, file_size, all_bytes_recvd;
	FILE *aFile;

	memset(header, 0, BUFFSIZE);

	// Parse received buffer for file name and file size
	parseARGS(header, buffer);
	file_name = header[1];
	file_size = atoi(header[2]);

	if(strlen(file_name) > 0){

		// Open a file stream in wite bin mode
		aFile = fopen(file_name, "wb");
		if(aFile == NULL)
			DieWithError("failed to open the file!\n");
		
   	// Receive file via socket, place it in 4096 Byte array 
   	// than write buffer content into file.
   	// Repeat until amount of all received Bytes equals file size. 
		memset(buffer, 0, BUFFSIZE);
		all_bytes_recvd = 0;
		while((bytes_recvd = recv(clntSock, buffer, BUFFSIZE, 0)) > 0){
			all_bytes_recvd += bytes_recvd;
			printf("Received %ld B, remaining data = %ld B\n", bytes_recvd, (file_size - all_bytes_recvd));

			if((bytes_written = fwrite(buffer, sizeof(char), bytes_recvd, aFile)) < 0)
				DieWithError("fwrite() failed!\n");

			if(all_bytes_recvd == file_size){
				printf("Finished UPLOAD!\n");
				break;
			}
		}

		// Close file stream
		fclose(aFile);	
	}
}
