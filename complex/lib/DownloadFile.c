#include "TCPServer.h"

void DownloadFile(int clntSock, char *sbuffer)
{
	int percent_sent;
	long bytes_sent, bytes_read, file_size, all_bytes_sent, bytes_left;
	char buffer[BUFFSIZE], *file_name, *header[BUFFSIZE];
	FILE *aFile;

	memset(header, 0, BUFFSIZE);

	// Parse buffer for file name 
	parseARGS(header, sbuffer);
	file_name = header[1];

	if(strlen(file_name) > 0){

		// Open file stream in read bin mode
		aFile = fopen(file_name, "rb");
		if(aFile == NULL)
			DieWithError("failed to open the file!\n");

		// Shift file stream indicatore to get file size
		fseek(aFile, 0, SEEK_END);
		file_size = ftell(aFile);
		rewind(aFile);

		bytes_left = file_size;
		// Prepare DOWNLOAD stat msg with file name and size 	
		memset(buffer, 0, BUFFSIZE);
		sprintf(buffer, "DOWNLOAD:%s:%ld\r\n", file_name, file_size);

		// Send DOWNLOAD stat msg via socket.
		// Repeat until amount of all sent Bytes equals 4096 Bytes. 
		all_bytes_sent = 0;
		while(all_bytes_sent != BUFFSIZE){
			bytes_sent = send(clntSock, (buffer + all_bytes_sent), (BUFFSIZE - all_bytes_sent), 0);
			if(bytes_sent < 0)
				DieWithError("send STAT msg failed!\n");		

			all_bytes_sent += bytes_sent;
			printf("STAT: Sent %ld B, remaining data = %ld B\n", bytes_sent, (BUFFSIZE - all_bytes_sent));
		}

		// Loop until all Bytes of the file will be send
		while(1){
			memset(buffer, 0, BUFFSIZE);

			// Read file into buffer
			if((bytes_read = fread(buffer, sizeof(char), BUFFSIZE, aFile)) < 0)
				DieWithError("failed to read the file!\n");	

			// Send file over socket
			if(bytes_read > 0){
				if((bytes_sent = send(clntSock, buffer, bytes_read, 0)) < 0)
					DieWithError("fialed to send the file!\n");

				// Calc percentage and display status
				bytes_left -= bytes_sent;
				percent_sent = ((file_size - bytes_left) * 100) / file_size;
				printf("Sent %d%% (%ld B), remaining = %ld B\n", percent_sent, bytes_sent, bytes_left);
			}

			// Check the end of the file
			// if it is End - break.
			if(bytes_read < BUFFSIZE){
				if(feof(aFile))
					printf("End of file.\n");
				if(ferror(aFile))
					printf("Error reading!\n");
				break;
			}
		}
		
		// Close file stream
		fclose(aFile);	
	}
}
