#include <stdio.h>
#include <stdlib.h>
#include <netdb.h>
#include <netinet/in.h>
#include <string.h>

#define BUFFSIZE 4096
#define PENDING 5

void DieWithError(int sock, char *msg);

int main(int argc, char *argv[])
{
	int sockfd, sockfd_clnt, bindme;
	char buffer[BUFFSIZE];
	struct sockaddr_in serv_addr, clnt_addr;
	unsigned int clnt_len = sizeof(clnt_addr);

	// Call socket
	sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if(sockfd < 0)
		DieWithError(sockfd, "socket()");

	// Init socket struct
	bzero((char *)&serv_addr, sizeof(server_addr));
	serv_addr.sin_family = AF_INET;
	serv_addr.sin_addr.s_addr = INADDR_ANY;
	serv_addr.sin_port = htons(argv[1]);

	// Bind the host addr
	bindme = bind(sockfd, (struct sockaddr*) &serv_addr, sizeof(server_addr));
	if(bindme < 0)
		DieWithError(sockfd, "bind()");

	// Listen for a client
	if(listen(sockfd, PENDING) < 0)
		DieWithError(sockfd, "listen()");

	// Accept connection from a client
	while(1){
		sockfd_clnt = accept(sockfd, (struct sockaddr*) &clnt_addr, &clnt_len); 	
		if(sockfd_cnt < 0)
			DieWithError(sockfd, "accept()");

		bzero(buffer, sizeof(buffer));	

		// Receive data
		bytes_recv = recv(sockfd_clnt, buffer, BUFFSIZE, 0);
		if(bytes_recv < 0)
			printf("Err: Failed to receive!\n");

		// Send data
		bytes_sent = send(sockfd_clnt, buffer, BUFFSIZE, 0);
		if(bytes_sent < 0)
			printf("Err: Failed to send!\n")	
	}

	// Close socket
	close(sockfd);

	return 0;
}

void DieWithError(int sock, char *msg)
{
	printf("ERROR: %s failed!\n", msg);
	close(sock);
	exit(1);
}
